<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LuciFoto</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#ff66b2"/>
<link rel="icon" href="icon-192.png">
<style>
:root{--glass:rgba(255,255,255,.85);--line:rgba(0,0,0,.08);--accent:#ff66b2;--ink:#1e2329}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;color:var(--ink);background:#ff66b2 url('background.jpg') center/cover no-repeat fixed;}
.wrap{max-width:980px;margin:0 auto;padding:12px;display:grid;gap:12px}
.card{background:var(--glass);backdrop-filter:blur(10px);border:1px solid var(--line);border-radius:14px;padding:14px}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px}
h1{font-size:1.1rem;margin:0}
.grid2{display:grid;gap:10px;grid-template-columns:1fr 1fr}
@media(max-width:760px){.grid2{grid-template-columns:1fr}}
label{font-size:.9rem;color:#374151}
input,select,textarea{width:100%;background:#fff;border:1px solid #ffd0e6;border-radius:10px;padding:10px 12px;outline:none}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.btn{border:1px solid transparent;background:var(--accent);color:#fff;font-weight:700;border-radius:12px;padding:12px 14px;cursor:pointer}
.btn.secondary{background:#fff;color:#111;border:1px solid #e5e7eb}.btn.ghost{background:transparent;color:#111;border:1px dashed #e5e7eb}
canvas{width:100%;max-width:960px;height:auto;background:#fff;border:1px solid #e5e7eb;border-radius:12px}
.badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.badge{padding:4px 8px;border:1px solid #e5e7eb;border-radius:999px;background:#fff;font-size:.85rem;color:#374151}
.gallery{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.thumb{border:1px solid #e5e7eb;border-radius:10px;overflow:hidden;background:#fff}
.thumb img{width:100%;display:block}
</style>
<script>
if('serviceWorker' in navigator){window.addEventListener('load',()=>{navigator.serviceWorker.register('sw.js').catch(console.error);});}
</script>
<script defer src="https://docs.opencv.org/4.x/opencv.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card header">
      <h1>üì∏ LuciFoto</h1>
      <div id="stat">Naƒç√≠t√°m moduly‚Ä¶</div>
    </div>

    <div class="card">
      <div class="actions" style="margin-bottom:10px">
        <input id="files" type="file" accept="image/*" capture="environment" multiple/>
        <button class="btn" id="processBtn">ü™Ñ Zpracovat</button>
        <button class="btn secondary" id="renderBtn">Vytvo≈ôit n√°hled</button>
        <button class="btn ghost" id="downloadBtn">St√°hnout fotku</button>
        <button class="btn ghost" id="exportCsvBtn">Export CSV (Vinted)</button>
      </div>
      <div class="gallery" id="gallery"></div>
      <canvas id="canvas" width="1080" height="1080"></canvas>
      <div class="badges">
        <span class="badge" id="mBadgePx">Mƒõ≈ô√≠tko: ‚Äì</span>
        <span class="badge" id="mBadgeW">≈†√≠≈ôka: ‚Äì</span>
        <span class="badge" id="mBadgeH">V√Ω≈°ka: ‚Äì</span>
      </div>
    </div>

    <div class="card">
      <div class="grid2">
        <div>
          <label>Reference mƒõ≈ô√≠tka</label>
          <select id="scaleRef">
            <option value="a4" selected>A4 list (29,7 √ó 21 cm)</option>
            <option value="manual">Vlastn√≠ p√°ska (zad√°m d√©lku)</option>
          </select>
        </div>
        <div id="manualLenWrap" style="display:none">
          <label>D√©lka p√°sky (cm)</label>
          <input id="manualLen" type="number" min="5" max="200" step="0.1" placeholder="30"/>
        </div>

        <div>
          <label>Kategorie</label>
          <select id="kategorie">
            <option value="">‚Äî vyber ‚Äî</option>
            <option>triƒçko</option><option>mikina</option><option>svetr</option><option>bunda</option>
            <option>kalhoty</option><option>kra≈•asy</option><option>suknƒõ</option><option>≈°aty</option><option>boty</option><option>doplnƒõk</option>
          </select>
        </div>
        <div>
          <label>Barva</label>
          <select id="barva">
            <option value="">‚Äî vyber ‚Äî</option>
            <option>b√≠l√°</option><option>ƒçern√°</option><option>≈°ed√°</option><option>modr√°</option><option>ƒçerven√°</option><option>r≈Ø≈æov√°</option>
            <option>zelen√°</option><option>b√©≈æov√°</option><option>hnƒõd√°</option><option>≈ælut√°</option><option>fialov√°</option><option>v√≠cebarevn√°</option>
          </select>
        </div>

        <div>
          <label>Velikost</label>
          <select id="velikost">
            <option>XS</option><option>S</option><option selected>M</option><option>L</option><option>XL</option><option>XXL</option>
          </select>
        </div>
        <div>
          <label>Pohlav√≠</label>
          <select id="gender">
            <option value="">‚Äî vyber ‚Äî</option><option>D√°msk√©</option><option>P√°nsk√©</option><option>Dƒõtsk√©</option>
          </select>
        </div>

        <div>
          <label>Stav</label>
          <select id="stav">
            <option>Nov√©</option><option>Jako nov√©</option><option selected>Velmi dobr√Ω</option><option>Dobr√Ω</option><option>Uspokojiv√Ω</option>
          </select>
        </div>
        <div>
          <label>Cena (Kƒç)</label>
          <input id="cena" type="number" min="0" step="1" placeholder="180"/>
        </div>

        <div>
          <label>Titulek</label>
          <input id="title" type="text" placeholder="Titulek produktu"/>
        </div>
        <div style="grid-column:1 / -1">
          <label>Popis</label>
          <textarea id="popis" rows="4" placeholder="Kr√°tk√Ω popis polo≈æky‚Ä¶"></textarea>
        </div>

        <div><label>M√≠ra 1</label><input id="mira1" type="text" placeholder="D√©lka: 45 cm"/></div>
        <div><label>M√≠ra 2</label><input id="mira2" type="text" placeholder="≈†√≠≈ôka: 33 cm"/></div>
        <div><label>M√≠ra 3</label><input id="mira3" type="text" placeholder="Ruk√°v: 42 cm"/></div>
        <div><label>M√≠ra 4</label><input id="mira4" type="text" placeholder="(voliteln√©)"/></div>
      </div>
    </div>
  </div>

<script>
const stat=document.getElementById('stat');
window.addEventListener('load',()=>{function wait(){if(typeof cv!=='undefined'){stat.textContent='P≈ôipraveno';}else setTimeout(wait,300);}wait();});

const scaleRef=document.getElementById('scaleRef'), manualLenWrap=document.getElementById('manualLenWrap');
scaleRef.addEventListener('change',()=>{ manualLenWrap.style.display=(scaleRef.value==='manual')?'block':'none'; });

const filesEl=document.getElementById('files'), gallery=document.getElementById('gallery'), canvas=document.getElementById('canvas'), ctx=canvas.getContext('2d');

filesEl.addEventListener('change', async (e)=>{
  gallery.innerHTML='';
  for(const f of e.target.files){
    const url=URL.createObjectURL(f);
    const d=document.createElement('div'); d.className='thumb'; d.innerHTML='<img src="'+url+'">'; gallery.appendChild(d);
  }
});

function containDraw(bmp){
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,1080,1080);
  const r=Math.min(1080/bmp.width,1080/bmp.height);
  const w=Math.round(bmp.width*r), h=Math.round(bmp.height*r);
  const x=Math.floor((1080-w)/2), y=Math.floor((1080-h)/2);
  ctx.drawImage(bmp,x,y,w,h);
  const pad=18; ctx.save(); ctx.font='600 26px system-ui, Segoe UI, Roboto, Arial'; ctx.fillStyle='rgba(0,0,0,0.18)';
  const t='üì∏ LuciFoto'; const m=ctx.measureText(t); ctx.fillText(t,1080-pad-m.width,1080-pad); ctx.restore();
}

function toMatFromBitmap(bmp){ const cnv=document.createElement('canvas'); cnv.width=bmp.width; cnv.height=bmp.height; cnv.getContext('2d').drawImage(bmp,0,0); return cv.imread(cnv); }

function detectA4PxPerCm(mat){
  let gray=new cv.Mat(); cv.cvtColor(mat, gray, cv.COLOR_RGBA2GRAY);
  let blur=new cv.Mat(); cv.GaussianBlur(gray, blur, new cv.Size(5,5), 0);
  let edges=new cv.Mat(); cv.Canny(blur, edges, 60, 160);
  let contours=new cv.MatVector(); let hierarchy=new cv.Mat();
  cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
  let best=null; let bestArea=0; const target=Math.SQRT2;
  for(let i=0;i<contours.size();i++){
    const cnt=contours.get(i); const area=cv.contourArea(cnt);
    if(area < (mat.rows*mat.cols*0.02)) continue;
    let approx=new cv.Mat(); cv.approxPolyDP(cnt, approx, 0.02*cv.arcLength(cnt,true), true);
    if(approx.rows===4){
      let xs=[],ys=[]; for(let j=0;j<4;j++){ xs.push(approx.data32S[j*2]); ys.push(approx.data32S[j*2+1]); }
      const minx=Math.min(...xs), maxx=Math.max(...xs), miny=Math.min(...ys), maxy=Math.max(...ys);
      const w=maxx-minx, h=maxy-miny; const ar=(w>h?w/h:h/w);
      if(Math.abs(ar-target) < 0.35 && area>bestArea){ bestArea=area; best={w,h}; }
    }
    approx.delete();
  }
  gray.delete(); blur.delete(); edges.delete(); contours.delete(); hierarchy.delete();
  if(!best) return null;
  const longPx=Math.max(best.w,best.h);
  return longPx/29.7;
}

async function processImage(){
  if(!filesEl.files.length){ alert('Nahraj fotku.'); return; }
  const bmp=await createImageBitmap(filesEl.files[0]);
  let pxPerCm=null;
  if(scaleRef.value==='a4'){
    try{ let mat=toMatFromBitmap(bmp); pxPerCm=detectA4PxPerCm(mat); mat.delete(); }catch(e){ pxPerCm=null; }
    if(!pxPerCm){ alert('A4 nebyl spolehlivƒõ rozpozn√°n. P≈ôep√≠n√°m na ruƒçn√≠ zad√°n√≠.'); scaleRef.value='manual'; manualLenWrap.style.display='block'; return; }
  }else{
    const len=parseFloat(document.getElementById('manualLen').value||'0');
    if(len<=0){ alert('Zadej d√©lku v cm (nap≈ô. 30).'); return; }
    pxPerCm = (bmp.width/len);
  }
  containDraw(bmp);
  const wcm=(bmp.width/pxPerCm), hcm=(bmp.height/pxPerCm);
  document.getElementById('mBadgePx').textContent='Mƒõ≈ô√≠tko: '+pxPerCm.toFixed(2)+' px/cm';
  document.getElementById('mBadgeW').textContent='≈†√≠≈ôka: '+wcm.toFixed(1)+' cm';
  document.getElementById('mBadgeH').textContent='V√Ω≈°ka: '+hcm.toFixed(1)+' cm';

  const vel=document.getElementById('velikost').value;
  const bar=document.getElementById('barva').value;
  document.getElementById('title').value = (bar? (bar+' ') : '') + (vel? ('‚Ä¢ '+vel) : '');
  const parts=['Velikost: '+vel, 'M√≠ry: d√©lka '+hcm.toFixed(1)+' cm, ≈°√≠≈ôka '+wcm.toFixed(1)+' cm'];
  if(bar) parts.push('Barva: '+bar);
  parts.push('Stav: '+document.getElementById('stav').value);
  document.getElementById('popis').value = parts.join('\n');
}

document.getElementById('processBtn').addEventListener('click', processImage);
document.getElementById('renderBtn').addEventListener('click', async ()=>{
  if(!filesEl.files.length){ alert('Nahraj fotku.'); return; }
  const bmp=await createImageBitmap(filesEl.files[0]); containDraw(bmp); alert('N√°hled hotov√Ω.');
});
document.getElementById('downloadBtn').addEventListener('click', ()=>{
  const c=document.getElementById('canvas');
  c.toBlob(b=>{ const a=document.createElement('a'); const url=URL.createObjectURL(b); a.href=url; a.download='lucifoto.jpg'; a.click(); URL.revokeObjectURL(url); }, 'image/jpeg', 0.92);
});
function toCSVRow(v){ return v.map(x=>'"'+String(x).replaceAll('"','""')+'"').join(','); }
document.getElementById('exportCsvBtn').addEventListener('click', ()=>{
  const row=[document.getElementById('title').value,document.getElementById('popis').value,document.getElementById('cena').value,document.getElementById('kategorie').value,document.getElementById('velikost').value,document.getElementById('stav').value,document.getElementById('gender').value,document.getElementById('barva').value];
  const header=['Titulek','Popis','CenaKc','Kategorie','Velikost','Stav','Pohlavi','Barva'];
  const csv=[toCSVRow(header),toCSVRow(row)].join('\n');
  const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); const url=URL.createObjectURL(blob); a.href=url; a.download='lucifoto_vinted.csv'; a.click(); URL.revokeObjectURL(url);
});
</script>
</body>
</html>
