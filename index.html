<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LuciFoto ‚Äî bez automatick√©ho mƒõ≈ôen√≠</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#ff66b2"/>
<link rel="icon" href="icon-192.png">
<style>
:root{--accent:#ff66b2;--glass:rgba(255,255,255,.9);--line:rgba(0,0,0,.06);--ink:#1b1b1b}
*{box-sizing:border-box}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#fff url('background.jpg') center/cover fixed;color:var(--ink)}
.container{max-width:1000px;margin:12px auto;padding:12px;display:grid;gap:12px}
.card{background:var(--glass);border:1px solid var(--line);border-radius:12px;padding:12px}
.header{display:flex;justify-content:space-between;align-items:center}
.actions{display:flex;gap:8px;flex-wrap:wrap}
input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #ffd6ea;background:#fff}
.btn{background:var(--accent);color:#fff;padding:10px 12px;border-radius:10px;border:0;cursor:pointer}
.gallery{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.thumb img{width:100%;display:block;border-radius:8px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
@media(max-width:760px){.grid2{grid-template-columns:1fr}}
.small{font-size:.9rem;color:#444}
</style>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="card header">
      <div style="font-weight:800">üì∏ LuciFoto ‚Äî manu√°ln√≠ mƒõ≈ôen√≠</div>
      <div id="status" class="small">P≈ôipraveno</div>
    </div>

    <div class="card">
      <div class="actions">
        <input id="file" type="file" accept="image/*" capture="environment"/>
        <button id="classifyBtn" class="btn">Rozpoznat typ a barvu</button>
        <button id="downloadBtn" class="btn" style="background:#fff;color:#111;border:1px solid var(--line)">St√°hnout n√°hled</button>
        <button id="exportBtn" class="btn" style="background:transparent;color:#111;border:1px dashed var(--line)">Export CSV (Vinted)</button>
      </div>
      <div style="margin-top:10px" id="gallery" class="gallery"></div>
      <canvas id="preview" width="900" height="900" style="max-width:100%;border-radius:10px;margin-top:10px;background:#fff"></canvas>
    </div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:8px">V√Ωsledky rozpozn√°n√≠</div>
      <div id="results" class="small">Nem√°≈° nic nahran√©.</div>
    </div>

    <div class="card">
      <div style="font-weight:700">Ruƒçnƒõ dopl≈àte m√≠ry a dal≈°√≠ √∫daje</div>
      <div class="grid2" style="margin-top:8px">
        <div><label>Typ (upravit)</label><select id="typ"><option value="">‚Äî vyber ‚Äî</option><option>triƒçko</option><option>mikina</option><option>svetr</option><option>bunda</option><option>kalhoty</option><option>suknƒõ</option><option>≈°aty</option><option>boty</option><option>doplnƒõk</option></select></div>
        <div><label>Barva (upravit)</label><select id="barva"><option value="">‚Äî vyber ‚Äî</option><option>b√≠l√°</option><option>ƒçern√°</option><option>≈°ed√°</option><option>modr√°</option><option>ƒçerven√°</option><option>r≈Ø≈æov√°</option><option>zelen√°</option><option>b√©≈æov√°</option><option>hnƒõd√°</option><option>≈ælut√°</option><option>fialov√°</option><option>v√≠cebarevn√°</option></select></div>
        <div><label>Velikost (obleƒçen√≠)</label><select id="velikostCloth"><option>XS</option><option>S</option><option>M</option><option>L</option><option>XL</option><option>XXL</option><option>XXXL</option></select></div>
        <div><label>Velikost (boty)</label><select id="velikostShoes"></select></div>
      </div>

      <div style="margin-top:10px">
        <label>Titulek</label>
        <input id="title" placeholder="Titulek polo≈æky"/>
      </div>
      <div style="margin-top:10px">
        <label>Popis</label>
        <textarea id="desc" rows="4" placeholder="Popis‚Ä¶"></textarea>
      </div>

      <div style="margin-top:10px" class="small">M√≠ry (zadej ruƒçnƒõ)</div>
      <div class="grid2" style="margin-top:8px">
        <div><input id="m1" placeholder="D√©lka (cm)"/></div>
        <div><input id="m2" placeholder="≈†√≠≈ôka (cm)"/></div>
        <div><input id="m3" placeholder="Ruk√°v / obvod (cm)"/></div>
        <div><input id="m4" placeholder="Dal≈°√≠ (cm)"/></div>
      </div>
      <div style="margin-top:10px" class="actions">
        <button id="uploadBtn" class="btn">Nahr√°t na Vinted (Export)</button>
      </div>
    </div>
  </div>

<script>
let net=null;
const status=document.getElementById('status');
const fileEl=document.getElementById('file');
const gallery=document.getElementById('gallery');
const preview=document.getElementById('preview');
const ctx=preview.getContext('2d');
const resultsEl=document.getElementById('results');
const typSel=document.getElementById('typ');
const barvaSel=document.getElementById('barva');
const sizeShoes=document.getElementById('velikostShoes');

for(let s=36;s<=46;s++){ const o=document.createElement('option'); o.textContent=s; o.value=s; sizeShoes.appendChild(o); }

async function loadModel(){
  status.textContent='Naƒç√≠t√°m model MobileNet‚Ä¶';
  try{
    net = await mobilenet.load();
    status.textContent='Model p≈ôipraven.';
  }catch(e){
    status.textContent='Chyba naƒçten√≠ modelu.';
    console.error(e);
  }
}
loadModel();

fileEl.addEventListener('change', async (e)=>{
  gallery.innerHTML='';
  const f = e.target.files[0];
  if(!f) return;
  const url = URL.createObjectURL(f);
  const d=document.createElement('div'); d.className='thumb'; d.innerHTML='<img src="'+url+'">'; gallery.appendChild(d);

  const img = new Image();
  img.onload = ()=>{
    const W=900, H=900;
    const r = Math.min(W/img.width, H/img.height);
    const w=Math.round(img.width*r), h=Math.round(img.height*r);
    ctx.fillStyle='#fff'; ctx.fillRect(0,0,W,H);
    ctx.drawImage(img, (W-w)/2, (H-h)/2, w, h);
  }
  img.src = url;
});

function detectBasicColor(canvasCtx, w=900, h=900){
  const imgData = canvasCtx.getImageData(0,0,w,h);
  let r=0,g=0,b=0,c=0;
  for(let i=0;i<imgData.data.length;i+=40){ r+=imgData.data[i]; g+=imgData.data[i+1]; b+=imgData.data[i+2]; c++; }
  r=Math.round(r/c); g=Math.round(g/c); b=Math.round(b/c);
  const colors = {'b√≠l√°':[255,255,255],'ƒçern√°':[20,20,20],'≈°ed√°':[128,128,128],'modr√°':[30,90,180],'ƒçerven√°':[190,30,45],'r≈Ø≈æov√°':[255,102,178],'zelen√°':[40,140,40],'b√©≈æov√°':[210,180,140],'hnƒõd√°':[120,70,20],'≈ælut√°':[240,200,40],'fialov√°':[140,60,170]};
  let best=null, bd=1e9;
  for(const k in colors){
    const [cr,cg,cb]=colors[k];
    const d = (r-cr)*(r-cr)+(g-cg)*(g-cg)+(b-cb)*(b-cb);
    if(d<bd){bd=d; best=k;}
  }
  if(bd>7000) return 'v√≠cebarevn√°';
  return best;
}

function mapLabelToCategory(label){
  label = label.toLowerCase();
  const mapping = [
    {k:['t-shirt','tshirt','jersey','sweatshirt','polo','shirt','top'],'v':'triƒçko'},
    {k:['jacket','coat','blazer','parka','overcoat'],'v':'bunda'},
    {k:['dress','gown'],'v':'≈°aty'},
    {k:['trouser','jeans','jean','pants','chino'],'v':'kalhoty'},
    {k:['skirt'],'v':'suknƒõ'},
    {k:['shoe','boot','sneaker','loafer','sandals','sandal'],'v':'boty'},
    {k:['bag','handbag','purse'],'v':'doplnƒõk'}
  ];
  for(const m of mapping){
    for(const key of m.k) if(label.includes(key)) return m.v;
  }
  return 'dopl≈àte';
}

document.getElementById('classifyBtn').addEventListener('click', async ()=>{
  if(!fileEl.files.length){ alert('Nahraj foto.'); return; }
  if(!net){ alert('Model se naƒç√≠t√°, chv√≠li poƒçkej.'); return; }
  const img = new Image();
  img.src = URL.createObjectURL(fileEl.files[0]);
  img.onload = async ()=>{
    const res = await net.classify(img);
    const top = res && res[0] ? res[0].className : '---';
    const cat = mapLabelToCategory(top);
    const color = detectBasicColor(ctx,900,900);
    resultsEl.innerHTML = '<b>V√Ωsledek (automatick√Ω n√°vrh):</b><br>Label: '+top+'<br>Kategorie: '+cat+'<br>Barva: '+color;
    if(cat && cat!=='dopl≈àte') typSel.value = cat;
    if(color) barvaSel.value = color;
    document.getElementById('title').value = (cat!=='dopl≈àte'?cat+' ':'') + (color? (color+' '):'') + '‚Äî p≈ôidej titulek';
    document.getElementById('desc').value = 'Rozpozn√°no: '+top+'; Doporuƒçen√° kategorie: '+cat+'; Barva: '+color;
  }
});

document.getElementById('downloadBtn').addEventListener('click', ()=>{
  preview.toBlob(b=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='lucifoto_preview.jpg'; a.click(); URL.revokeObjectURL(a.href); },'image/jpeg',0.9);
});

document.getElementById('exportBtn').addEventListener('click', ()=>{
  const fields = [
    document.getElementById('title').value,
    document.getElementById('desc').value,
    document.getElementById('typ').value,
    document.getElementById('velikostCloth').value,
    document.getElementById('velikostShoes').value,
    document.getElementById('barva').value,
    document.getElementById('m1').value,
    document.getElementById('m2').value,
    document.getElementById('m3').value,
    document.getElementById('m4').value
  ];
  const header = ['Titulek','Popis','Kategorie','Velikost_obleƒç','Velikost_boty','Barva','M1','M2','M3','M4'];
  const csv = [header.join(','), fields.map(f => '"'+String(f).replace(/"/g,'""')+'"').join(',')].join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='lucifoto_vinted.csv'; a.click(); URL.revokeObjectURL(a.href);
});

document.getElementById('uploadBtn').addEventListener('click', ()=>{
  alert('CSV vytvo≈ôeno. St√°hni CSV a nahraj do Vinted ruƒçnƒõ. (Automatick√© nahr√°v√°n√≠ na Vinted by vy≈æadovalo jejich API a p≈ôihl√°≈°en√≠.)');
});
</script>
</body>
</html>